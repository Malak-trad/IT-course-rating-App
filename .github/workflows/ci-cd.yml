name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/education-rating-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/education-rating-frontend
  IMAGE_NAME_MONGODB: ${{ github.repository }}/education-rating-mongodb

jobs:
  # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
      - name: â¬‡ï¸ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v3

      - name: ğŸŸ¢ ØªØ«Ø¨ÙŠØª Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Backend
        working-directory: ./backend
        run: |
          npm ci
          npm audit fix

      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Backend
        working-directory: ./backend
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test-secret-key
        run: |
          npm test -- --coverage
          npm run test:security

      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØºØ·ÙŠØ©
        uses: codecov/codecov-action@v3
        with:
          directory: ./backend/coverage
          flags: backend
          name: backend-coverage

      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª
        working-directory: ./backend
        run: |
          npm audit --production

      - name: ğŸ“ ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ğŸ“ ÙØ­Øµ Ù…Ù„ÙØ§Øª Frontend
        run: |
          echo "ğŸ” ÙØ­Øµ Ù…Ù„ÙØ§Øª Frontend..."
          find ./frontend -name "*.html" -exec wc -l {} + | tail -1
          echo "âœ… ØªÙ… ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª"

  # Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ± Docker
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: â¬‡ï¸ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v3

      - name: ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: ğŸ³ Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ·ï¸ Ø¥Ø¶Ø§ÙØ© Tags Ø¥Ø¶Ø§ÙÙŠØ©
        run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

      - name: ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Helm Chart
        run: |
          mkdir -p helm-chart/templates
          cat > helm-chart/Chart.yaml <<EOF
          apiVersion: v2
          name: education-rating-system
          description: Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ø·Ù„Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø¢Ù„ÙŠ
          version: 1.0.0
          appVersion: "${{ github.sha }}"
          EOF

          cat > helm-chart/values.yaml <<EOF
          replicaCount: 3
          image:
            repository: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
            tag: latest
            pullPolicy: Always
          service:
            type: ClusterIP
            port: 5000
          ingress:
            enabled: true
            className: nginx
            hosts:
              - host: edu-rating.example.com
                paths:
                  - path: /
                    pathType: Prefix
            tls: []
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          autoscaling:
            enabled: true
            minReplicas: 2
            maxReplicas: 10
            targetCPUUtilizationPercentage: 80
          EOF

      - name: ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Docker Compose Ù„Ù„Ø¥Ù†ØªØ§Ø¬
        run: |
          cat > docker-compose.prod.yml <<EOF
          version: '3.8'

          services:
            mongodb:
              image: mongo:6.0
              container_name: education_rating_mongodb
              restart: unless-stopped
              environment:
                MONGO_INITDB_ROOT_USERNAME: \$MONGO_INITDB_ROOT_USERNAME
                MONGO_INITDB_ROOT_PASSWORD: \$MONGO_INITDB_ROOT_PASSWORD
                MONGO_INITDB_DATABASE: education_rating
              volumes:
                - mongodb_data:/data/db
                - ./mongodb/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
              networks:
                - education_network

            backend:
              image: \${{ env.REGISTRY }}/\${{ env.IMAGE_NAME_BACKEND }}:latest
              container_name: education_rating_backend
              restart: unless-stopped
              environment:
                NODE_ENV: production
                PORT: 5000
                MONGODB_URI: mongodb://\$\${MONGO_INITDB_ROOT_USERNAME}:\$\${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/education_rating?authSource=admin
                JWT_SECRET: \$\${JWT_SECRET}
              ports:
                - "5000:5000"
              volumes:
                - backend_uploads:/usr/src/app/uploads
              depends_on:
                - mongodb
              networks:
                - education_network

            frontend:
              image: \${{ env.REGISTRY }}/\${{ env.IMAGE_NAME_FRONTEND }}:latest
              container_name: education_rating_frontend
              restart: unless-stopped
              ports:
                - "80:80"
              depends_on:
                - backend
              networks:
                - education_network

          networks:
            education_network:
              driver: bridge

          volumes:
            mongodb_data:
              driver: local
            backend_uploads:
              driver: local
          EOF

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
        uses: actions/upload-artifact@v3
        with:
          name: deployment-files
          path: |
            docker-compose.prod.yml
            helm-chart/
          retention-days: 30

  # Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ VPS Ø£Ùˆ Ø®Ø§Ø¯Ù…
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # ØªØ¹Ø±ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙƒØ¨ÙŠØ¦Ø©
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      MONGO_USER: ${{ secrets.MONGO_USER }}
      MONGO_PASS: ${{ secrets.MONGO_PASS }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      DOCKER_COMPOSE_CONTENT: ${{ secrets.DOCKER_COMPOSE_CONTENT }}

    steps:
      - name: â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø±
        uses: actions/download-artifact@v3
        with:
          name: deployment-files

      - name: ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: ğŸš€ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            mkdir -p /opt/education-rating-system
            cd /opt/education-rating-system

            # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø±
            cat > docker-compose.yml << 'EOF'
            $DOCKER_COMPOSE_CONTENT
            EOF

            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env
            cat > .env << EOF
            NODE_ENV=production
            PORT=5000
            MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASS}@mongodb:27017/education_rating?authSource=admin
            JWT_SECRET=${JWT_SECRET}
            MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
            MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
            EOF

            # Ø³Ø­Ø¨ Ø£Ø­Ø¯Ø« Ø§Ù„ØµÙˆØ±
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

            # Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
            docker-compose down
            docker-compose up -d --remove-orphans

            # ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            docker system prune -f --filter "until=24h"

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
            sleep 10
            docker-compose ps

            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø±
            echo "âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ $(date)" >> /opt/education-rating-system/deploy.log

  # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ØµØ¯Ø§Ø±
  release:
    needs: [test, build-and-push, deploy]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: ğŸ·ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø¥ØµØ¯Ø§Ø± Docker
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.event.release.tag_name }}

          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.event.release.tag_name }}

      - name: ğŸ“‹ ØªØ­Ø¯ÙŠØ« Changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.event.release.tag_name }}

      - name: ğŸ‰ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployments"
          author_name: "GitHub Actions"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±
  post-deploy-test:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}

    steps:
      - name: ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API
        run: |
          sleep 30 # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²Ø§Ù‹
          curl -f http://$SERVER_HOST:5000/ || exit 1
          echo "âœ… API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­"

          curl -f http://$SERVER_HOST/ || exit 1
          echo "âœ… Frontend ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­"

      - name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        run: |
          # Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          curl -X POST http://$SERVER_HOST:5000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@edu-rating.com","password":"Admin123"}' \
            -w "\nHTTP Status: %{http_code}\n" \
            --fail || echo "âš ï¸ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙØ´Ù„"

          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯
          curl -f http://$SERVER_HOST:5000/api/subjects || exit 1
          echo "âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ù†Ø§Ø¬Ø­"

      - name: ğŸ“Š Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ­Ø©
        uses: LouisBrunner/checks-action@v1.6.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: "Health Check Report"
          conclusion: ${{ job.status == 'success' && 'success' || 'failure' }}
          output: |
            {
              "summary": "ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±",
              "text": "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ"
            }

  # Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  monitoring:
    runs-on: ubuntu-latest
    if: always()
    
    env:
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: ğŸ“ˆ Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
        run: |
          # Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø­Ø§Ù„Ø© CI/CD
          echo "ğŸ“Š ØªÙ‚Ø±ÙŠØ± CI/CD"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Status: ${{ job.status }}"
          echo "Time: $(date)"

      - name: ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ env.EMAIL_USERNAME }}
          password: ${{ env.EMAIL_PASSWORD }}
          subject: "âŒ ÙØ´Ù„ CI/CD - Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©"
          to: ${{ env.EMAIL_TO }}
          from: "GitHub Actions"
          body: |
            ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© CI/CD Ù„Ù„Ù…Ø´Ø±ÙˆØ¹: ${{ github.repository }}

            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}
            Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ´Ù„: ${{ job.status }}

            -- 
            Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©
            Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± - ÙƒÙ„ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø¢Ù„ÙŠ

      - name: ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Discord
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          title: "âŒ ÙØ´Ù„ CI/CD"
          description: "ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© CI/CD Ù„Ù„Ù…Ø´Ø±ÙˆØ¹: ${{ github.repository }}"
          color: 0xFF0000
          url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "GitHub Actions Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  # Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      MONGO_USER: ${{ secrets.MONGO_USER }}
      MONGO_PASS: ${{ secrets.MONGO_PASS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || '' }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET || '' }}

    steps:
      - name: ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/education-rating-system
            docker-compose exec -T mongodb mongodump \
              --username $MONGO_USER \
              --password $MONGO_PASS \
              --authenticationDatabase admin \
              --db education_rating \
              --out /backup/$(date +%Y%m%d_%H%M%S)

            # Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ù„Ù‰ S3 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            if [ -n "$AWS_ACCESS_KEY_ID" ]; then
              docker-compose exec -T mongodb tar -czf - /backup | \
              aws s3 cp - s3://$AWS_S3_BUCKET/backup-$(date +%Y%m%d).tar.gz
            fi

            # Ø­ÙØ¸ Ø¢Ø®Ø± 7 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙ‚Ø·
            docker-compose exec -T mongodb find /backup -type d -mtime +7 -exec rm -rf {} +

            echo "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­"

      - name: ğŸ“‹ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        run: |
          echo "ğŸ“… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØªÙ… ÙÙŠ $(date)" >> backup.log
          echo "âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­" >> backup.log

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true